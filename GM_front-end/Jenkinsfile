pipeline {
    agent any

    environment {
        DOCKER_IMAGE = 'goal-frontend-app'
        DOCKER_TAG = "${BUILD_NUMBER}"
        AWS_EC2_HOST = '18.119.159.233'  // Public IP of your EC2 instance
        AWS_USER = 'ec2-user'  // Username for EC2 (Amazon Linux or Ubuntu)
        FRONTEND_FOLDER = 'GM_front-end' // Folder containing the frontend code
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    // Checkout the code from GitHub
                    checkout scm
                }
            }
        }

        stage('Build Frontend Docker Image') {
            steps {
                script {
                    // Build the React app Docker image locally (on Jenkins server) using the Dockerfile
                    dir("${FRONTEND_FOLDER}") {
                        sh 'docker build --no-cache -t ${DOCKER_IMAGE}:${DOCKER_TAG} .'
                    }
                }
            }
        }

     /*   stage('Test Frontend') {
            steps {
                script {
                    // Run tests (e.g., Jest tests) on the frontend, if needed
                    dir("${FRONTEND_FOLDER}") {
                        sh 'npm install'  // Install dependencies
                        sh 'npm run test' // Run tests
                    }
                }
            }
        }*/

        stage('Deploy to EC2') {
            steps {
                script {
                    // SSH into EC2 and stop/remove any old container
                    sh """
                    ssh -o StrictHostKeyChecking=no $AWS_USER@$AWS_EC2_HOST 'docker stop ${DOCKER_IMAGE} || true'
                    ssh -o StrictHostKeyChecking=no $AWS_USER@$AWS_EC2_HOST 'docker rm ${DOCKER_IMAGE} || true'

                    // Copy the code from the Jenkins workspace to the EC2 instance
                    scp -o StrictHostKeyChecking=no -r ${WORKSPACE}/${FRONTEND_FOLDER} $AWS_USER@$AWS_EC2_HOST:/home/$AWS_USER/${FRONTEND_FOLDER}

                    // SSH into EC2, navigate to the frontend folder, build the Docker image there, and run it
                    ssh -o StrictHostKeyChecking=no $AWS_USER@$AWS_EC2_HOST <<EOF
                        cd /home/$AWS_USER/${FRONTEND_FOLDER}  # Change to the frontend folder
                        docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .  # Build Docker image
                        docker run -d -p 80:80 --name ${DOCKER_IMAGE} ${DOCKER_IMAGE}:${DOCKER_TAG}  # Run container
                    EOF
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'Frontend pipeline executed successfully!'
        }
        failure {
            echo 'Frontend pipeline failed!'
        }
    }
}

